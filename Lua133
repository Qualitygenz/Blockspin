local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local DroppedFolder = workspace:WaitForChild("DroppedItems")

local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

local Window = WindUI:CreateWindow({
    Title = "Quality x [Blockspin]​",
    Icon = "rbxassetid://138614699274576",
    Author = "x2Nyx.real",
    Folder = "MySuperHub",
    Size = UDim2.fromOffset(580, 460),
    MinSize = Vector2.new(560, 350),
    MaxSize = Vector2.new(850, 560),
    Transparent = true,
    Theme = "Dark",
    Resizable = true,
    SideBarWidth = 200,
    BackgroundImageTransparency = 0.42,
    HideSearchBar = true,
    ScrollBarEnabled = false,
    User = {
        Enabled = true,
        Anonymous = false,
        Name = LocalPlayer.Name,
        Image = "rbxthumb://type=AvatarHeadShot&id=" .. LocalPlayer.UserId,
        Callback = function() end,
    },
})

Window:EditOpenButton({ Enabled = false })

local ScreenGui = Instance.new("ScreenGui")
local ToggleBtn = Instance.new("ImageButton")

ScreenGui.Name = "WindUI_Toggle"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = CoreGui

ToggleBtn.Size = UDim2.new(0, 50, 0, 50)
ToggleBtn.Position = UDim2.new(0, 20, 0.5, -25)
ToggleBtn.BackgroundTransparency = 1
ToggleBtn.Image = "rbxassetid://138614699274576" 
ToggleBtn.Active = true
ToggleBtn.Draggable = true
ToggleBtn.Parent = ScreenGui

local opened = true

local function toggle()
    opened = not opened
    if Window.UI then
        Window.UI.Enabled = opened
    else
        Window:Toggle()
    end
end

ToggleBtn.MouseButton1Click:Connect(function()
    ToggleBtn:TweenSize(
        UDim2.new(0, 56, 0, 56),
        Enum.EasingDirection.Out,
        Enum.EasingStyle.Quad,
        0.12,
        true,
        function()
            ToggleBtn:TweenSize(
                UDim2.new(0, 50, 0, 50),
                Enum.EasingDirection.Out,
                Enum.EasingStyle.Quad,
                0.12,
                true
            )
        end
    )
    toggle()
end)

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.T then
        toggle()
    end
end)


if not LocalPlayer.Character then
LocalPlayer.CharacterAdded:Wait()
end

local MainTab = Window:Tab({Title = "Main", Icon = "house"})
local CombatTab = Window:Tab({Title = "Combat", Icon = "sword"})
local EspTab = Window:Tab({Title = "Esp", Icon = "eye"})
local CarTab = Window:Tab({Title = "Car", Icon = "car"})
local MiscTab = Window:Tab({Title = "Misc", Icon = "hard-drive"})
local SeverTab = Window:Tab({Title = "server", Icon = "server"})

local SilentAim = false
local SelectedBodyPart = "Head"
local IgnoredPlayers = {}
local CurrentTarget = nil

--// =========================
--// FOV CIRCLE
--// =========================
local FOVCircle = Drawing.new("Circle")
FOVCircle.Radius = 150
FOVCircle.Thickness = 1
FOVCircle.Filled = false
FOVCircle.Color = Color3.fromRGB(255,255,255)
FOVCircle.Visible = false

CombatTab:Toggle({
    Title = "Show FOV",
    Callback = function(v)
        FOVCircle.Visible = v
    end
})

CombatTab:Slider({
    Title = "FOV Size",
    Step = 1,
    Value = {Min=50, Max=800, Default=150},
    Callback = function(v)
        FOVCircle.Radius = v
    end
})

CombatTab:Toggle({
    Title = "Silent Aim",
    Callback = function(v)
        SilentAim = v
    end
})

CombatTab:Dropdown({
    Title = "Aim Part",
    Values = {"Head","HumanoidRootPart"},
    Value = "Head",
    Callback = function(v)
        SelectedBodyPart = v
    end
})

--// =========================
--// SAVE FRIENDS
--// =========================
local function GetPlayerList()
    local t = {}
    for _,p in ipairs(Players:GetPlayers()) do
        if p ~= LocalPlayer then
            table.insert(t,p.Name)
        end
    end
    return t
end

CombatTab:Dropdown({
    Title = "Save Friends",
    Values = GetPlayerList(),
    Multi = true,
    Callback = function(list)
        table.clear(IgnoredPlayers)
        for _,n in ipairs(list) do
            table.insert(IgnoredPlayers,n)
        end
    end
})

--// =========================
--// SILENT AIM CORE
--// =========================
local function IsIgnored(plr)
    for _,n in ipairs(IgnoredPlayers) do
        if plr.Name == n then
            return true
        end
    end
    return false
end

local function GetPing()
    local stats = LocalPlayer:FindFirstChild("PlayerGui")
        and LocalPlayer.PlayerGui:FindFirstChild("NetworkStats")
    if stats and stats:FindFirstChild("PingLabel") then
        local p = tonumber(stats.PingLabel.Text:match("%d+"))
        return p and p/1000 or 0.15
    end
    return 0.15
end

local function GetClosestTarget()
    local closest, shortest = nil, math.huge
    local center = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)

    for _,plr in ipairs(Players:GetPlayers()) do
        if plr ~= LocalPlayer
        and not IsIgnored(plr)
        and plr.Character
        and plr.Character:FindFirstChild(SelectedBodyPart)
        and plr.Character:FindFirstChild("HumanoidRootPart")
        and plr.Character:FindFirstChildOfClass("Humanoid")
        and plr.Character.Humanoid.Health > 0 then

            local part = plr.Character[SelectedBodyPart]
            local pos, onscreen = Camera:WorldToViewportPoint(part.Position)

            if onscreen then
                local dist = (Vector2.new(pos.X,pos.Y) - center).Magnitude
                if dist <= FOVCircle.Radius and dist < shortest then
                    shortest = dist
                    closest = plr
                end
            end
        end
    end
    return closest
end

--// =========================
--// WALL CHECK
--// =========================
local function IsVisible(targetChar, part)
    local origin = Camera.CFrame.Position
    local direction = (part.Position - origin)

    local params = RaycastParams.new()
    params.FilterType = Enum.RaycastFilterType.Blacklist
    params.FilterDescendantsInstances = {
        LocalPlayer.Character,
        targetChar
    }
    params.IgnoreWater = true

    local result = workspace:Raycast(origin, direction, params)

    if not result then
        return true
    end

    if result.Instance:IsDescendantOf(targetChar) then
        return true
    end

    return false
end

--// =========================
--// UPDATE TARGET + FOV
--// =========================
RunService.RenderStepped:Connect(function()
    FOVCircle.Position = Vector2.new(
        Camera.ViewportSize.X/2,
        Camera.ViewportSize.Y/2
    )
    CurrentTarget = SilentAim and GetClosestTarget() or nil
end)

--// =========================
--// FIRE SERVER HOOK
--// =========================
local oldFire
oldFire = hookfunction(ReplicatedStorage.Remotes.Send.FireServer, function(self,...)
    local args = {...}

    if SilentAim
    and CurrentTarget
    and args[2] == "shoot_gun"
    and LocalPlayer.Character
    and LocalPlayer.Character:FindFirstChild("Head") then

        local char = CurrentTarget.Character
        local part = char and char:FindFirstChild(SelectedBodyPart)
        local hrp  = char and char:FindFirstChild("HumanoidRootPart")

        if part and hrp then
            if IsVisible(char, part) then
                -- ยิงปกติ
                local ping = GetPing()
                local aimPos = part.Position + (hrp.Velocity * ping * 1.1)

                args[4] = CFrame.new(
                    LocalPlayer.Character.Head.Position,
                    aimPos
                )

                args[5] = {
                    [1] = {
                        [1] = {
                            Instance = part,
                            Position = aimPos,
                            Normal = Vector3.new(0,1,0)
                        }
                    }
                }
            else
                -- หลังกำแพง
                args[4] = CFrame.new(math.huge, math.huge, math.huge)
            end
        end
    end

    return oldFire(self, unpack(args))
end)

--// =========================
--// RGB TRACER (หลังกำแพงก็ขึ้น)
--// =========================
local Tracer = Drawing.new("Line")
Tracer.Visible = false
Tracer.Thickness = 1.5
Tracer.Transparency = 1

local hue = 0

RunService.RenderStepped:Connect(function()
    hue += 0.005
    if hue > 1 then hue = 0 end
    Tracer.Color = Color3.fromHSV(hue, 1, 1)

    local center = Vector2.new(
        Camera.ViewportSize.X / 2,
        Camera.ViewportSize.Y / 2
    )

    if SilentAim
    and CurrentTarget
    and CurrentTarget.Character
    and CurrentTarget.Character:FindFirstChild(SelectedBodyPart)
    and FOVCircle.Visible then

        local part = CurrentTarget.Character[SelectedBodyPart]
        local pos, onScreen = Camera:WorldToViewportPoint(part.Position)

        if onScreen then
            local screenPos = Vector2.new(pos.X, pos.Y)

            if (screenPos - center).Magnitude <= FOVCircle.Radius then
                Tracer.From = center
                Tracer.To = screenPos
                Tracer.Visible = true
                return
            end
        end
    end

    Tracer.Visible = false
end)
