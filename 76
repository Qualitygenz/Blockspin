local RunService = game:GetService("RunService")
local Players = game:GetService("Players")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local LocalPlayer = Players.LocalPlayer
local Camera = workspace.CurrentCamera
local CoreGui = game:GetService("CoreGui")
local UserInputService = game:GetService("UserInputService")
local DroppedFolder = workspace:WaitForChild("DroppedItems")

local WindUI = loadstring(game:HttpGet("https://github.com/Footagesus/WindUI/releases/latest/download/main.lua"))()

local Window = WindUI:CreateWindow({
    Title = "Quality x [Blockspin]â€‹",
    Icon = "rbxassetid://138614699274576",
    Author = "x2Nyx.real",
    Folder = "MySuperHub",
    Size = UDim2.fromOffset(580, 460),
    MinSize = Vector2.new(560, 350),
    MaxSize = Vector2.new(850, 560),
    Transparent = true,
    Theme = "Dark",
    Resizable = true,
    SideBarWidth = 200,
    BackgroundImageTransparency = 0.42,
    HideSearchBar = true,
    ScrollBarEnabled = false,
    User = {
        Enabled = true,
        Anonymous = false,
        Name = LocalPlayer.Name,
        Image = "rbxthumb://type=AvatarHeadShot&id=" .. LocalPlayer.UserId,
        Callback = function() end,
    },
})

Window:EditOpenButton({ Enabled = false })

local ScreenGui = Instance.new("ScreenGui")
local ToggleBtn = Instance.new("ImageButton")

ScreenGui.Name = "WindUI_Toggle"
ScreenGui.ResetOnSpawn = false
ScreenGui.Parent = CoreGui

ToggleBtn.Size = UDim2.new(0, 50, 0, 50)
ToggleBtn.Position = UDim2.new(0, 20, 0.5, -25)
ToggleBtn.BackgroundTransparency = 1
ToggleBtn.Image = "rbxassetid://138614699274576" 
ToggleBtn.Active = true
ToggleBtn.Draggable = true
ToggleBtn.Parent = ScreenGui

local opened = true

local function toggle()
    opened = not opened
    if Window.UI then
        Window.UI.Enabled = opened
    else
        Window:Toggle()
    end
end

ToggleBtn.MouseButton1Click:Connect(function()
    ToggleBtn:TweenSize(
        UDim2.new(0, 56, 0, 56),
        Enum.EasingDirection.Out,
        Enum.EasingStyle.Quad,
        0.12,
        true,
        function()
            ToggleBtn:TweenSize(
                UDim2.new(0, 50, 0, 50),
                Enum.EasingDirection.Out,
                Enum.EasingStyle.Quad,
                0.12,
                true
            )
        end
    )
    toggle()
end)

UserInputService.InputBegan:Connect(function(input, gp)
    if gp then return end
    if input.KeyCode == Enum.KeyCode.T then
        toggle()
    end
end)


if not LocalPlayer.Character then
LocalPlayer.CharacterAdded:Wait()
end

local MainTab = Window:Tab({Title = "Main", Icon = "house"})
local CombatTab = Window:Tab({Title = "Combat", Icon = "sword"})
local EspTab = Window:Tab({Title = "Esp", Icon = "eye"})
local CarTab = Window:Tab({Title = "Car", Icon = "car"})
local MiscTab = Window:Tab({Title = "Misc", Icon = "hard-drive"})
local SeverTab = Window:Tab({Title = "server", Icon = "server"})

-- Combat 
local SilentAim = false
local Superbullet = false

-- FOV Circle
local FOVCircle = Drawing.new("Circle")
FOVCircle.Radius = 150
FOVCircle.Thickness = 0.5
FOVCircle.Filled = false
FOVCircle.Color = Color3.fromRGB(255, 255, 255)
FOVCircle.Position = Vector2.new(Camera.ViewportSize.X/2, Camera.ViewportSize.Y/2)
FOVCircle.Visible = false
local showFov = false

CombatTab:Toggle({
    Title = "Show Fov",
    Default = false,
    Callback = function(state)
        showFov = state
        FOVCircle.Visible = showFov
    end
})

CombatTab:Slider({
    Title = "FOV Size",
    Step = 1,
    Value = {Min = 50, Max = 800, Default = FOVCircle.Radius},
    Callback = function(value)
        FOVCircle.Radius = tonumber(value)
    end
})

CombatTab:Toggle({
    Title = "Silent Aim",
    Default = false,
    Callback = function(v)
        SilentAim = v
    end
})

CombatTab:Toggle({
    Title = "Super bullet",
    Default = false,
    Callback = function(v)
        EnableSuperbullet = v
    end
})

-- Body Part
local CurrentTarget
local BodyPartOptions = {"Head", "HumanoidRootPart"}
local SelectedBodyPart = "Head"

CombatTab:Dropdown({
    Flag = "TargetBodyPart",
    Title = "aim Part",
    Values = {"Head", "HumanoidRootPart"}
    Callback = function(option)
        SelectedBodyPart = option
    end
})

-- Ignore Players
local Players = game:GetService("Players")
local IgnoredPlayers = {}

local function GetPlayerDropdownOptions()
    local options = {}
    for _, player in pairs(Players:GetPlayers()) do
        table.insert(options, player.Name) string
    end
    return options
end

local ignoreDropdown
ignoreDropdown = CombatTab:Dropdown({
    Flag = "IgnorePlayers",
    Title = "Save Friends",
    Values = GetPlayerDropdownOptions(),
    Value = {},
    Multi = true,
    Callback = function(selectedOptions)
        IgnoredPlayers = {}
        for _, v in ipairs(selectedOptions) do
            table.insert(IgnoredPlayers, v) 
        end
    end
})

CombatTab:Button({
    Title = "Reset Save Friends",
    Callback = function()
        IgnoredPlayers = {}
        if ignoreDropdown then
            if ignoreDropdown.Reset then
                ignoreDropdown:Reset()
            end
            if ignoreDropdown.SetValues then
                ignoreDropdown:SetValues(GetPlayerDropdownOptions())
            end
        end
    end
})

Players.PlayerAdded:Connect(function(player)
    if ignoreDropdown and ignoreDropdown.SetValues then
        ignoreDropdown:SetValues(GetPlayerDropdownOptions())
    end
end)

Players.PlayerRemoving:Connect(function(player)
    for i=#IgnoredPlayers,1,-1 do
        if IgnoredPlayers[i] == player.Name then
            table.remove(IgnoredPlayers,i)
        end
    end
    if ignoreDropdown and ignoreDropdown.SetValues then
        ignoreDropdown:SetValues(GetPlayerDropdownOptions())
    end
end)

-- Debug Gun
local DebugGuns = {
    ["P226"]=true, ["MP5"]=true, ["M24"]=true, ["Draco"]=true, ["Glock"]=true,
    ["Sawnoff"]=true, ["Uzi"]=true, ["G3"]=true, ["C9"]=true, ["Hunting Rifle"]=true,
    ["Anaconda"]=true, ["AK47"]=true, ["Remington"]=true, ["Double Barrel"]=true
}

local function IsHoldingAllowedGun(args)
    local ok, weapon = pcall(function() return args[3] end)
    if not ok then return false end
    if typeof(weapon) == "Instance" and DebugGuns[weapon.Name] then return true end
    for _, child in pairs(LocalPlayer.Character:GetChildren()) do
        if (child:IsA("Tool") or child:IsA("Model")) and DebugGuns[child.Name] then return true end
    end
    return false
end

-- Tracer Line
local tracerLine = Drawing.new("Line")
tracerLine.Color = Color3.fromRGB(255,0,0)
tracerLine.Thickness = 2
tracerLine.Visible = false

-- Perfiction
local PREDICTION_BASE = 0.15
local WALLBANG_FACTOR_ROOT = 1.0
local WALLBANG_FACTOR_SEAT = 1.2
local HEAD_VEL_FACTOR = 0.1
local ROOT_VEL_FACTOR = 0.12

local function PredictPosition(part, enableWallBang)
    local root = part.Parent:FindFirstChild("HumanoidRootPart")
    if not root then return part.Position end

    local velocityFactor = (part.Name == "Head") and HEAD_VEL_FACTOR or ROOT_VEL_FACTOR
    local baseVelocity = root.Velocity
    if part:IsA("BasePart") then
        baseVelocity = baseVelocity + (part.Velocity * velocityFactor)
    end

    local prediction = part.Position + (baseVelocity * PREDICTION_BASE)

    if enableWallBang then
        local seat = root:FindFirstChildWhichIsA("WeldConstraint") or root:FindFirstChildWhichIsA("Weld")
        if seat and seat.Part0 and seat.Part0.Velocity then
            local rootVel = root.Velocity * WALLBANG_FACTOR_ROOT
            local seatVel = seat.Part0.Velocity * WALLBANG_FACTOR_SEAT
            prediction = part.Position + ((rootVel + seatVel) * PREDICTION_BASE)
        end
    end

    return prediction
end

-- Debug Bullet Function
local function SpawnDebugBullet(startPos, targetPos)
    local dist = (targetPos - startPos).Magnitude
    local beam = Instance.new("Part")
    beam.Anchored = true
    beam.CanCollide = false
    beam.Material = Enum.Material.Neon
    beam.Size = Vector3.new(0.1,0.1,dist)
    beam.CFrame = CFrame.new(startPos, targetPos) * CFrame.new(0,0,-dist/2)
    local hue = (tick()*0.5)%1
    beam.Color = Color3.fromHSV(hue, 1, 1)
    beam.Parent = workspace
    Debris:AddItem(beam, 0.5)
end



